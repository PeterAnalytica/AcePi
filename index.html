<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AcePi Suite ‚Äì Hybrid Ledger & Payments Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --border: #1f2937;
      --border-soft: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-soft: #0f766e;
      --danger: #ef4444;
      --shadow: rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a, #020617 50%, #020617);
      color: var(--text);
    }
    header {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(2,6,23,0.95);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }
    header p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }
    header .meta {
      text-align: right;
      font-size: 11px;
      color: var(--muted);
    }
    main {
      max-width: 1240px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1.05fr 1.05fr;
      grid-gap: 16px;
    }
    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 16px 16px 18px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .card h2 {
      margin-top: 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #22c55e33;
      background: rgba(15,118,110,0.25);
      color: #a7f3d0;
    }
    .muted { font-size: 12px; color: var(--muted); }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
      color: var(--muted);
    }
    input, select, textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text);
      padding: 7px 8px;
      font-size: 12px;
      font-family: inherit;
      margin-bottom: 8px;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    select { cursor: pointer; }
    input:focus, select:focus, textarea:focus {
      outline: 1px solid var(--accent-soft);
      border-color: var(--accent-soft);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 8px;
    }
    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 8px;
    }
    @media (max-width: 640px) {
      .row, .row-3 { grid-template-columns: 1fr; }
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-right: 6px;
      margin-top: 4px;
    }
    .btn-primary {
      background: var(--accent);
      color: #022c22;
    }
    .btn-secondary {
      background: #0f172a;
      border: 1px solid #374151;
      color: var(--text);
    }
    .btn-ghost {
      background: transparent;
      border: 1px dashed #4b5563;
      color: var(--muted);
    }
    .btn-danger {
      background: var(--danger);
      color: #fef2f2;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      min-height: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--border-soft);
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      color: var(--muted);
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }
    tbody tr:hover { background: rgba(15,23,42,0.7); }
    .badge {
      border-radius: 999px;
      padding: 0 7px;
      font-size: 10px;
      display: inline-block;
      border: 1px solid #4b5563;
      color: var(--muted);
    }
    .badge.in {
      border-color: #22c55e80;
      color: #bbf7d0;
    }
    .badge.out {
      border-color: #f9737380;
      color: #fecaca;
    }
    .scroll {
      max-height: 230px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
    }
    pre {
      background: #020617;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 8px;
      font-size: 11px;
      max-height: 220px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 8px;
      margin-top: 8px;
      font-size: 11px;
    }
    .summary-item {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #020617;
    }
    .summary-item strong {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
    }
    .summary-item span { font-size: 12px; }
    .tagline {
      font-size: 10px;
      margin-top: 6px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>AcePi Suite</h1>
      <p>Unified payments capture + ledger intelligence for Pi, fiat & Web3 ‚Äì powering ACA Brain.</p>
    </div>
    <div class="meta">
      Ace Consulting & Analytics (ACA) ¬∑ AcePi Suite v1.0<br />
      Data spine for: ACA Brain ¬∑ ACA Control Room ¬∑ Ace Insights
    </div>
  </header>

  <main>
    <!-- LEFT: Capture + Payload -->
    <section class="card">
      <h2>
        1. Merchant Profile, Capture & Payload
        <span class="pill">Pi + Fiat + Web3 Rails</span>
      </h2>
      <p class="muted">
        Configure your business once, capture payments, then generate a full AcePi payload JSON to feed the engine
        and ACA Brain.
      </p>

      <!-- Business profile -->
      <h3 style="font-size:13px;margin-top:10px;">Business Profile</h3>
      <div class="row">
        <div>
          <label for="bizName">Business Name</label>
          <input id="bizName" placeholder="e.g. Ace Hybrid Retail & Web3 Hub" />
        </div>
        <div>
          <label for="bizIndustry">Industry</label>
          <input id="bizIndustry" placeholder="e.g. Retail & Digital Services" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="bizCountry">Base Country</label>
          <input id="bizCountry" placeholder="e.g. Nigeria" />
        </div>
        <div>
          <label for="baseCurrency">Base Currency</label>
          <input id="baseCurrency" placeholder="e.g. NGN" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="defaultTaxCountry">Default Tax Country Code</label>
          <input id="defaultTaxCountry" placeholder="e.g. NG" />
        </div>
        <div>
          <label for="profilePreset">Quick Preset</label>
          <select id="profilePreset">
            <option value="">Select preset‚Ä¶</option>
            <option value="ng-retail">Nigeria ‚Äì Retail & Digital</option>
            <option value="us-saas">US ‚Äì SaaS / Info Products</option>
            <option value="uk-consult">UK ‚Äì Consulting / Advisory</option>
          </select>
        </div>
      </div>
      <button class="btn-secondary" id="applyPresetBtn">Apply Preset</button>
      <button class="btn-primary" id="saveProfileBtn">Save Profile</button>
      <span class="status" id="profileStatus"></span>

      <hr style="border:none;border-top:1px dashed #1f2937;margin:14px 0 10px;" />

      <!-- Payment capture -->
      <h3 style="font-size:13px;margin-top:0;">Capture Payment</h3>
      <div class="row">
        <div>
          <label for="txDate">Date</label>
          <input id="txDate" type="date" />
        </div>
        <div>
          <label for="txDirection">Direction</label>
          <select id="txDirection">
            <option value="in">Inflow (money in)</option>
            <option value="out">Outflow (money out)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="txAmount">Amount (base)</label>
          <input id="txAmount" type="number" step="0.0001" placeholder="e.g. 350000" />
        </div>
        <div>
          <label for="txCurrency">Currency</label>
          <input id="txCurrency" placeholder="e.g. NGN, USD, PI, USDC" />
        </div>
      </div>
      <label for="txDescription">Description</label>
      <textarea id="txDescription" placeholder="e.g. Pi payment for in-store groceries, Binance USDT deposit, Amazon purchase‚Ä¶"></textarea>

      <div class="row-3">
        <div>
          <label for="txChannel">Payment Channel</label>
          <select id="txChannel">
            <option value="">Select‚Ä¶</option>
            <option value="pi">Pi Network</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="card">Card / POS</option>
            <option value="binance">Binance</option>
            <option value="bybit">Bybit</option>
            <option value="okx">OKX</option>
            <option value="metamask">MetaMask</option>
            <option value="ton">TON</option>
            <option value="amazon">Amazon</option>
            <option value="alibaba">Alibaba</option>
            <option value="wix">Wix</option>
            <option value="nvidia">NVIDIA</option>
            <option value="investopedia">Investopedia</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label for="txChain">Chain (if on-chain)</label>
          <select id="txChain">
            <option value="">OFFCHAIN / N/A</option>
            <option value="pi">Pi</option>
            <option value="base">Base</option>
            <option value="bsc">BSC</option>
            <option value="eth">Ethereum</option>
            <option value="ton">TON</option>
          </select>
        </div>
        <div>
          <label for="txTaxCountry">Tax Country Code</label>
          <input id="txTaxCountry" placeholder="e.g. NG, US, UK" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="txCounterparty">Counterparty Type</label>
          <select id="txCounterparty">
            <option value="">Select‚Ä¶</option>
            <option value="customer">Customer</option>
            <option value="supplier">Supplier</option>
            <option value="exchange">Exchange</option>
            <option value="merchant">Merchant</option>
            <option value="exam_body">Exam Body</option>
            <option value="education_institution">Education Institution</option>
            <option value="professional_body">Professional Body</option>
            <option value="information_service">Information Service</option>
            <option value="network">Network / Gas</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label for="txId">Transaction ID (optional)</label>
          <input id="txId" placeholder="Leave blank to auto-generate" />
        </div>
      </div>

      <details style="margin-top:4px;">
        <summary class="muted" style="font-size:11px;cursor:pointer;">FX details (optional)</summary>
        <div class="row">
          <div>
            <label for="fxCurrency">FX Currency</label>
            <input id="fxCurrency" placeholder="e.g. USD, GBP, USDT, PI" />
          </div>
          <div>
            <label for="fxAmount">FX Amount</label>
            <input id="fxAmount" type="number" step="0.0001" placeholder="e.g. 1000" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fxRate">FX Rate ‚Üí Base</label>
            <input id="fxRate" type="number" step="0.000001" placeholder="e.g. 1500 (NGN per USD)" />
          </div>
          <div>
            <label for="fxFee">FX Fee (base)</label>
            <input id="fxFee" type="number" step="0.01" placeholder="e.g. 5000" />
          </div>
        </div>
      </details>

      <div style="margin-top:8px;">
        <button class="btn-primary" id="addTxBtn">‚ûï Add Payment</button>
        <button class="btn-secondary" id="clearTxFormBtn">Clear Form</button>
        <button class="btn-ghost" id="loadSampleTxBtn">Load Sample Transactions</button>
      </div>
      <span class="status" id="txStatus"></span>

      <!-- Session ledger -->
      <h3 style="font-size:13px;margin-top:14px;">Session Ledger (Captured Payments)</h3>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Date</th><th>Dir</th><th>Amt</th><th>Cur</th>
              <th>Channel</th><th>Chain</th><th>Tax</th><th>FX</th><th></th>
            </tr>
          </thead>
          <tbody id="txTableBody">
            <tr><td colspan="10" class="muted" style="padding:8px;">No payments captured yet.</td></tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:8px;">
        <button class="btn-danger" id="clearAllBtn">Clear All</button>
      </div>

      <!-- Summary of captured -->
      <div class="summary-grid" id="summaryGrid">
        <div class="summary-item">
          <strong>Transactions</strong>
          <span id="sumTxCount">0</span>
        </div>
        <div class="summary-item">
          <strong>Inflows (base)</strong>
          <span id="sumIn">0.00</span>
        </div>
        <div class="summary-item">
          <strong>Outflows (base)</strong>
          <span id="sumOut">0.00</span>
        </div>
        <div class="summary-item">
          <strong>Net Position</strong>
          <span id="sumNet">0.00</span>
        </div>
      </div>

      <hr style="border:none;border-top:1px dashed #1f2937;margin:14px 0 10px;" />

      <!-- AcePi payload builder -->
      <h3 style="font-size:13px;margin-top:0;">AcePi Payload (Input to Engine)</h3>
      <p class="muted">
        Option A: Click ‚ÄúBuild from Captured Ledger‚Äù to generate a structured AcePi payload.<br />
        Option B: Paste your own JSON payload (from ERP, CSV pipelines or external systems).<br />
        Option C: Use ‚ÄúLoad Master Demo Payload‚Äù.
      </p>
      <textarea id="payloadInput" placeholder="{ &quot;business_profile&quot;: { ... }, &quot;transactions&quot;: [ ... ] }"></textarea>
      <div style="margin-top:6px;">
        <button class="btn-primary" id="buildPayloadBtn">üß± Build from Captured Ledger</button>
        <button class="btn-secondary" id="loadDemoBtn">üß™ Load Master Demo Payload</button>
        <button class="btn-ghost" id="clearPayloadBtn">Clear Payload</button>
      </div>
      <span class="status" id="payloadStatus"></span>

      <p class="tagline">
        AcePi Suite is your unified data spine. The same payload can feed ACA Brain, ACA Control Room and Ace Insights.
      </p>
    </section>

    <!-- RIGHT: Engine + Output -->
    <section class="card">
      <h2>
        2. AcePi Engine Output & Intelligence
        <span class="pill">Ledger ¬∑ Tax ¬∑ FX ¬∑ Chains</span>
      </h2>
      <p class="muted">
        AcePi Lite runs fully in your browser ‚Äì classifying, posting and enriching transactions with tax, FX and chain
        intelligence. No backend required for this prototype.
      </p>

      <div style="margin-bottom:8px;">
        <button class="btn-primary" id="runBtn">‚ñ∂ Run AcePi Lite</button>
        <button class="btn-secondary" id="downloadBtn" disabled>‚¨á Download JSON Output</button>
      </div>
      <span class="status" id="status"></span>

      <h3 style="font-size:13px;margin-top:10px;">Raw AcePi Output (JSON)</h3>
      <pre id="output">(no output yet)</pre>

      <h3 style="margin-top:10px;font-size:13px;">Summary View</h3>
      <pre id="summary">(no summary yet)</pre>

      <h3 style="margin-top:10px;font-size:13px;">Analytics View (categories, chains, channels)</h3>
      <pre id="analytics">(no analytics yet)</pre>

      <h3 style="margin-top:10px;font-size:13px;">FX Overview</h3>
      <pre id="fxOverview">(no FX data yet)</pre>

      <h3 style="margin-top:10px;font-size:13px;">Insights (auto-generated draft)</h3>
      <pre id="insights">(no insights yet)</pre>
    </section>
  </main>

  <script>
    // ----------------------------
    // Default tax profile & chart of accounts aligned with AcePi
    // ----------------------------
    const defaultTaxProfileNG = {
      country: "NG",
      vat_applicable: true,
      vat_registered: true,
      vat_rate: 0.075,
      treat_sales_as_vat_inclusive: true,
      withholding_tax_enabled: true,
      default_wht_service_rate: 0.10,
      default_wht_contract_rate: 0.05,
      default_wht_rent_rate: 0.10,
      input_vat_claimable: true
    };

    const defaultChartOfAccounts = [
      { code: "1000", name: "Cash and Bank", type: "asset" },
      { code: "1010", name: "On-chain Wallet - Base (USDC)", type: "asset" },
      { code: "1011", name: "On-chain Wallet - Pi", type: "asset" },
      { code: "2000", name: "Accounts Payable", type: "liability" },
      { code: "3000", name: "Owner's Equity", type: "equity" },
      { code: "4000", name: "Sales Revenue (Local)", type: "income" },
      { code: "4010", name: "Sales Revenue (On-chain)", type: "income" },
      { code: "4011", name: "Sales Revenue (Pi Network)", type: "income" },
      { code: "5000", name: "Cost of Goods Sold", type: "expense" },
      { code: "6001", name: "Office & Shop Expenses", type: "expense" },
      { code: "6002", name: "Professional Fees Expense", type: "expense" },
      { code: "6003", name: "Rent Expense", type: "expense" },
      { code: "6005", name: "Network Fees (Gas)", type: "expense" },
      { code: "9999", name: "Unclassified Transaction", type: "expense" }
    ];

    // ----------------------------
    // Master demo payload ‚Äì multi-country, FX, Pi, Base, exchanges & merchants
    // (trimmed to the same structure as earlier AcePi engine demo)
    // ----------------------------
    const masterDemoPayload = {
      business_profile: {
        business_name: "Ace Hybrid Retail & Web3 Hub",
        industry: "Retail & Digital Services",
        country: "Nigeria",
        base_currency: "NGN"
      },
      tax_profile: Object.assign({}, defaultTaxProfileNG),
      chart_of_accounts: defaultChartOfAccounts,
      transactions: [
        {
          id: "DEM-001",
          date: "2025-11-20",
          amount: 350000,
          currency: "NGN",
          description: "In-store POS sales for the day",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pos",
          tax_country: "NG"
        },
        {
          id: "DEM-002",
          date: "2025-11-20",
          amount: 145000,
          currency: "NGN",
          description: "Inventory purchase from local supplier (wholesale goods)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-003",
          date: "2025-11-21",
          amount: 25000,
          currency: "NGN",
          description: "Office rent for November (shop space)",
          direction: "out",
          counterparty_type: "landlord",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-004",
          date: "2025-11-21",
          amount: 42000,
          currency: "NGN",
          description: "Payment to freelance graphic designer for marketing flyers",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-005",
          date: "2025-11-22",
          amount: 180000,
          currency: "NGN",
          description: "Online sales paid via bank transfer (Jumia-like order)",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-006",
          date: "2025-11-23",
          amount: 300,
          currency: "USDC",
          description: "Online order paid in USDC on Base",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "onchain",
          chain: "base",
          tx_hash: "0xbase300usdcin",
          wallet_address: "0xHybridStoreWallet",
          counterparty_wallet: "0xCustomerWallet1",
          contract_address: null,
          token_symbol: "USDC",
          token_decimal: 6,
          gas_fee: 0.00025,
          gas_currency: "ETH",
          tax_country: "NG"
        },
        {
          id: "DEM-007",
          date: "2025-11-23",
          amount: 120,
          currency: "USDC",
          description: "Payment to web developer in USDC for website update",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "onchain",
          chain: "base",
          tx_hash: "0xbase120usdcout",
          wallet_address: "0xHybridStoreWallet",
          counterparty_wallet: "0xDeveloperWallet",
          contract_address: null,
          token_symbol: "USDC",
          token_decimal: 6,
          gas_fee: 0.00030,
          gas_currency: "ETH",
          tax_country: "NG"
        },
        {
          id: "DEM-009",
          date: "2025-11-24",
          amount: 60,
          currency: "PI",
          description: "Sale of goods paid with Pi Network at physical store",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pi",
          chain: "pi",
          tx_hash: "0xpi60sale",
          wallet_address: "PiBusinessWalletAddress",
          counterparty_wallet: "PiCustomerWallet1",
          contract_address: null,
          token_symbol: "PI",
          token_decimal: 8,
          gas_fee: 0,
          gas_currency: "PI",
          tax_country: "NG"
        },
        {
          id: "DEM-010",
          date: "2025-11-24",
          amount: 15,
          currency: "PI",
          description: "Small business service payment to local technician in Pi",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "pi",
          chain: "pi",
          tx_hash: "0xpi15service",
          wallet_address: "PiBusinessWalletAddress",
          counterparty_wallet: "PiTechnicianWallet",
          contract_address: null,
          token_symbol: "PI",
          token_decimal: 8,
          gas_fee: 0,
          gas_currency: "PI",
          tax_country: "NG"
        }
      ]
    };

    // ----------------------------
    // State
    // ----------------------------
    let businessProfile = {
      business_name: "",
      industry: "",
      country: "",
      base_currency: "NGN"
    };
    let defaultTaxCountryCode = "NG";
    let sessionTransactions = [];
    let lastResult = null;

    // LocalStorage keys
    const LS_KEY_PROFILE = "acepi_suite_profile";
    const LS_KEY_TX = "acepi_suite_transactions";

    // ----------------------------
    // DOM elements
    // ----------------------------
    const bizNameEl = document.getElementById("bizName");
    const bizIndustryEl = document.getElementById("bizIndustry");
    const bizCountryEl = document.getElementById("bizCountry");
    const baseCurrencyEl = document.getElementById("baseCurrency");
    const defaultTaxCountryEl = document.getElementById("defaultTaxCountry");
    const profilePresetEl = document.getElementById("profilePreset");
    const profileStatusEl = document.getElementById("profileStatus");

    const txDateEl = document.getElementById("txDate");
    const txDirectionEl = document.getElementById("txDirection");
    const txAmountEl = document.getElementById("txAmount");
    const txCurrencyEl = document.getElementById("txCurrency");
    const txDescriptionEl = document.getElementById("txDescription");
    const txChannelEl = document.getElementById("txChannel");
    const txChainEl = document.getElementById("txChain");
    const txTaxCountryEl = document.getElementById("txTaxCountry");
    const txCounterpartyEl = document.getElementById("txCounterparty");
    const txIdEl = document.getElementById("txId");

    const fxCurrencyEl = document.getElementById("fxCurrency");
    const fxAmountEl = document.getElementById("fxAmount");
    const fxRateEl = document.getElementById("fxRate");
    const fxFeeEl = document.getElementById("fxFee");

    const txStatusEl = document.getElementById("txStatus");
    const txTableBodyEl = document.getElementById("txTableBody");

    const sumTxCountEl = document.getElementById("sumTxCount");
    const sumInEl = document.getElementById("sumIn");
    const sumOutEl = document.getElementById("sumOut");
    const sumNetEl = document.getElementById("sumNet");

    const payloadInput = document.getElementById("payloadInput");
    const payloadStatusEl = document.getElementById("payloadStatus");

    const outputEl = document.getElementById("output");
    const summaryEl = document.getElementById("summary");
    const analyticsEl = document.getElementById("analytics");
    const fxOverviewEl = document.getElementById("fxOverview");
    const insightsEl = document.getElementById("insights");
    const statusEl = document.getElementById("status");

    const applyPresetBtn = document.getElementById("applyPresetBtn");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const addTxBtn = document.getElementById("addTxBtn");
    const clearTxFormBtn = document.getElementById("clearTxFormBtn");
    const loadSampleTxBtn = document.getElementById("loadSampleTxBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");

    const buildPayloadBtn = document.getElementById("buildPayloadBtn");
    const loadDemoBtn = document.getElementById("loadDemoBtn");
    const clearPayloadBtn = document.getElementById("clearPayloadBtn");

    const runBtn = document.getElementById("runBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    // ----------------------------
    // LocalStorage helpers
    // ----------------------------
    function loadFromStorage() {
      try {
        const p = localStorage.getItem(LS_KEY_PROFILE);
        if (p) {
          const parsed = JSON.parse(p);
          Object.assign(businessProfile, parsed);
        }
      } catch (e) { console.warn("Profile LS parse error", e); }

      try {
        const t = localStorage.getItem(LS_KEY_TX);
        if (t) {
          const parsedTx = JSON.parse(t);
          if (Array.isArray(parsedTx)) sessionTransactions = parsedTx;
        }
      } catch (e) { console.warn("Tx LS parse error", e); }
    }

    function saveProfileToStorage() {
      try { localStorage.setItem(LS_KEY_PROFILE, JSON.stringify(businessProfile)); }
      catch (e) { console.warn("Profile LS save error", e); }
    }

    function saveTxToStorage() {
      try { localStorage.setItem(LS_KEY_TX, JSON.stringify(sessionTransactions)); }
      catch (e) { console.warn("Tx LS save error", e); }
    }

    // ----------------------------
    // UI update
    // ----------------------------
    function renderProfileToForm() {
      bizNameEl.value = businessProfile.business_name || "";
      bizIndustryEl.value = businessProfile.industry || "";
      bizCountryEl.value = businessProfile.country || "";
      baseCurrencyEl.value = businessProfile.base_currency || "NGN";
      defaultTaxCountryEl.value = defaultTaxCountryCode || "NG";
    }

    function renderTransactionsTable() {
      if (!sessionTransactions.length) {
        txTableBodyEl.innerHTML = '<tr><td colspan="10" class="muted" style="padding:8px;">No payments captured yet.</td></tr>';
        updateSummary();
        return;
      }
      txTableBodyEl.innerHTML = "";
      sessionTransactions.forEach((tx, index) => {
        const tr = document.createElement("tr");
        const fxLabel = tx.fx_currency
          ? `${tx.fx_amount || ""} ${tx.fx_currency} @ ${tx.fx_rate_to_base || ""}`
          : "";
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${tx.date || ""}</td>
          <td><span class="badge ${tx.direction === "in" ? "in" : "out"}">${tx.direction}</span></td>
          <td>${Number(tx.amount || 0).toFixed(2)}</td>
          <td>${tx.currency || ""}</td>
          <td>${tx.payment_channel || ""}</td>
          <td>${tx.chain || ""}</td>
          <td>${tx.tax_country || ""}</td>
          <td>${fxLabel}</td>
          <td><button class="btn-ghost" data-index="${index}" style="padding:2px 6px;font-size:10px;">‚úï</button></td>
        `;
        txTableBodyEl.appendChild(tr);
      });
      txTableBodyEl.querySelectorAll("button[data-index]").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.getAttribute("data-index"), 10);
          if (!isNaN(idx)) {
            sessionTransactions.splice(idx, 1);
            saveTxToStorage();
            renderTransactionsTable();
          }
        });
      });
      updateSummary();
    }

    function updateSummary() {
      let count = sessionTransactions.length;
      let sumIn = 0;
      let sumOut = 0;
      sessionTransactions.forEach(tx => {
        const amt = Number(tx.amount || 0);
        if (tx.direction === "in") sumIn += amt;
        else sumOut += amt;
      });
      const net = sumIn - sumOut;
      sumTxCountEl.textContent = String(count);
      sumInEl.textContent = sumIn.toFixed(2);
      sumOutEl.textContent = sumOut.toFixed(2);
      sumNetEl.textContent = net.toFixed(2);
    }

    function buildAcePiPayloadFromCaptured() {
      const bp = {
        business_name: businessProfile.business_name || "AcePi Suite Merchant",
        industry: businessProfile.industry || "Hybrid commerce",
        country: businessProfile.country || "Nigeria",
        base_currency: businessProfile.base_currency || "NGN"
      };
      const taxCountryCode = (defaultTaxCountryEl.value || defaultTaxCountryCode || "NG").toUpperCase();
      const tax_profile = Object.assign({}, defaultTaxProfileNG, { country: taxCountryCode });

      const transactions = sessionTransactions.map(tx => Object.assign({}, tx));

      return {
        business_profile: bp,
        tax_profile,
        chart_of_accounts: defaultChartOfAccounts,
        transactions
      };
    }

    // ----------------------------
    // AcePi Lite Engine
    // ----------------------------
    function acepiLiteEngine(payload) {
      const business_profile = payload.business_profile || {};
      const tax_profile = payload.tax_profile || {};
      const baseCurrency = business_profile.base_currency || "NGN";
      const txs = Array.isArray(payload.transactions) ? payload.transactions : [];

      const entries = [];
      let totalIn = 0;
      let totalOut = 0;

      txs.forEach(tx => {
        const direction = tx.direction === "out" ? "out" : "in";
        const rawAmount = Number(tx.amount || 0);
        const txCurrency = tx.currency || baseCurrency;

        const fx = {};
        if (tx.fx_currency && tx.fx_amount && tx.fx_rate_to_base) {
          fx.fx_currency = String(tx.fx_currency).toUpperCase();
          fx.fx_amount = Number(tx.fx_amount);
          fx.fx_rate_to_base = Number(tx.fx_rate_to_base);
          fx.base_amount_from_fx = fx.fx_amount * fx.fx_rate_to_base;
          fx.recorded_base_amount = rawAmount;
          fx.fx_fee = Number(tx.fx_fee || 0);
          fx.fx_diff = fx.recorded_base_amount - fx.base_amount_from_fx - fx.fx_fee;
        } else {
          fx.fx_currency = txCurrency;
          fx.fx_amount = rawAmount;
          fx.fx_rate_to_base = txCurrency === baseCurrency ? 1 : 1;
          fx.base_amount_from_fx = rawAmount * fx.fx_rate_to_base;
          fx.recorded_base_amount = rawAmount;
          fx.fx_fee = Number(tx.fx_fee || 0);
          fx.fx_diff = 0;
        }

        const baseAmount = fx.recorded_base_amount;
        if (direction === "in") totalIn += baseAmount;
        else totalOut += baseAmount;

        const chain = (tx.chain || "OFFCHAIN").toUpperCase();
        const payment_channel = (tx.payment_channel || "unknown").toLowerCase();
        const desc = (tx.description || "").toLowerCase();

        let category = "other";
        let incomeCode = "4000";
        let incomeName = "Sales Revenue (Local)";

        if (chain === "BASE" || chain === "BSC" || chain === "ETH" || chain === "TON") {
          incomeCode = "4010";
          incomeName = "Sales Revenue (On-chain)";
        }
        if (chain === "PI") {
          incomeCode = "4011";
          incomeName = "Sales Revenue (Pi Network)";
        }

        if (direction === "in") {
          if (desc.includes("sale") || desc.includes("sales") || desc.includes("order") || desc.includes("payment received")) {
            category = chain === "PI" || chain === "BASE" || chain === "BSC" ? "onchain_income" : "income";
          } else {
            category = "income";
          }
        } else {
          if (desc.includes("rent")) category = "rent_expense";
          else if (desc.includes("inventory") || desc.includes("goods") || desc.includes("stock")) category = "goods_purchase";
          else if (desc.includes("exam") || desc.includes("tuition") || desc.includes("school") || desc.includes("university")) category = "education_expense";
          else if (desc.includes("subscription")) category = "subscription_expense";
          else if (desc.includes("fee") || desc.includes("gas")) category = "network_or_fee_expense";
          else if (desc.includes("graphic") || desc.includes("developer") || desc.includes("service") || desc.includes("professional")) category = "service_expense";
          else category = "operating_expense";
        }

        let matched_account_code = "9999";
        let matched_account_name = "Unclassified Transaction";

        if (direction === "in") {
          matched_account_code = incomeCode;
          matched_account_name = incomeName;
        } else {
          if (category === "goods_purchase") {
            matched_account_code = "5000";
            matched_account_name = "Cost of Goods Sold";
          } else if (category === "rent_expense") {
            matched_account_code = "6003";
            matched_account_name = "Rent Expense";
          } else if (category === "service_expense" || category === "education_expense" || category === "subscription_expense") {
            matched_account_code = "6002";
            matched_account_name = "Professional Fees Expense";
          } else if (category === "network_or_fee_expense") {
            matched_account_code = "6005";
            matched_account_name = "Network Fees (Gas)";
          } else {
            matched_account_code = "6001";
            matched_account_name = "Office & Shop Expenses";
          }
        }

        const classification = {
          category,
          matched_account_code,
          matched_account_name,
          confidence_score: 0.9
        };

        let debit, credit;
        if (direction === "in") {
          debit = { code: "1000", name: "Cash and Bank", amount: baseAmount };
          credit = { code: matched_account_code, name: matched_account_name, amount: baseAmount };
        } else {
          debit = { code: matched_account_code, name: matched_account_name, amount: baseAmount };
          credit = { code: "1000", name: "Cash and Bank", amount: baseAmount };
        }

        const taxCountry = tx.tax_country || tax_profile.country || business_profile.country || "Unknown";
        const tax_analysis = buildTaxAnalysis(baseAmount, direction, category, tax_profile);

        entries.push({
          transaction_id: tx.id || tx.tx_id || tx.hash || "TX-" + (entries.length + 1),
          date: tx.date || null,
          raw_description: tx.description || "",
          amount: baseAmount,
          original_amount: rawAmount,
          original_currency: txCurrency,
          direction,
          tax_country: taxCountry,
          chain: tx.chain || null,
          tx_hash: tx.tx_hash || null,
          wallet_address: tx.wallet_address || null,
          counterparty_wallet: tx.counterparty_wallet || null,
          payment_channel,
          counterparty_type: tx.counterparty_type || null,
          classification,
          ledger_entry: { debit, credit },
          tax_analysis,
          fx
        });
      });

      const summary = {
        total_transactions: entries.length,
        total_inflows: Number(totalIn.toFixed(4)),
        total_outflows: Number(totalOut.toFixed(4)),
        notes: "Generated by AcePi Suite Lite in the browser. For production, connect to the full AcePi / ACA Brain engine."
      };

      return {
        business_profile,
        summary,
        entries
      };
    }

    function buildTaxAnalysis(amount, direction, category, tax_profile) {
      const vat_applicable = !!tax_profile.vat_applicable;
      const vat_rate = Number(tax_profile.vat_rate || 0);
      const treatInclusive = !!tax_profile.treat_sales_as_vat_inclusive;
      const withholdingEnabled = !!tax_profile.withholding_tax_enabled;

      let vat_amount = 0;
      let vat_type = "none";

      if (vat_applicable && vat_rate > 0) {
        if (direction === "in") {
          if (treatInclusive) vat_amount = amount - amount / (1 + vat_rate);
          else vat_amount = amount * vat_rate;
          vat_type = "output";
        } else {
          if (treatInclusive) vat_amount = amount - amount / (1 + vat_rate);
          else vat_amount = amount * vat_rate;
          vat_type = "input";
        }
      }

      let withholding_tax_applicable = false;
      let withholding_tax_amount = 0;

      if (withholdingEnabled && direction === "out") {
        if (category === "rent_expense") {
          withholding_tax_applicable = true;
          withholding_tax_amount = amount * Number(tax_profile.default_wht_rent_rate || 0.10);
        } else if (category === "service_expense" || category === "education_expense" || category === "subscription_expense") {
          withholding_tax_applicable = true;
          withholding_tax_amount = amount * Number(tax_profile.default_wht_service_rate || 0.10);
        }
      }

      let tax_category = direction === "in" ? "taxable income" : "allowable expense";

      return {
        vat_applicable,
        vat_amount: Number(vat_amount.toFixed(4)),
        vat_type,
        withholding_tax_applicable,
        withholding_tax_amount: Number(withholding_tax_amount.toFixed(4)),
        tax_category,
        tax_notes: "Lite estimate only ‚Äì final treatment depends on detailed tax rules and documentation."
      };
    }

    // ----------------------------
    // Summary, analytics, FX overview & insights
    // ----------------------------
    function buildSummary(result) {
      if (!result) return "(no summary yet)";
      const s = result.summary || {};
      const bp = result.business_profile || {};
      const lines = [];
      if (bp.business_name) lines.push(`Business: ${bp.business_name}`);
      if (bp.industry) lines.push(`Industry: ${bp.industry}`);
      if (bp.country) lines.push(`Country: ${bp.country}`);
      if (bp.base_currency) lines.push(`Base currency: ${bp.base_currency}`);
      lines.push("");
      lines.push(`Total transactions: ${s.total_transactions ?? 0}`);
      lines.push(`Total inflows: ${Number(s.total_inflows || 0).toFixed(2)}`);
      lines.push(`Total outflows: ${Number(s.total_outflows || 0).toFixed(2)}`);
      const net = (Number(s.total_inflows || 0) - Number(s.total_outflows || 0)).toFixed(2);
      lines.push(`Net: ${net}`);
      if (s.notes) {
        lines.push("");
        lines.push(s.notes);
      }
      return lines.join("\n");
    }

    function buildAnalytics(result) {
      if (!result || !Array.isArray(result.entries)) return "(no analytics yet)";
      const entries = result.entries;
      const byCategory = {};
      const byChain = {};
      const byChannel = {};

      entries.forEach(e => {
        const amt = Number(e.amount || 0);
        const cat = (e.classification && e.classification.category) || "unknown";
        const chain = (e.chain || "OFFCHAIN").toUpperCase();
        const channel = (e.payment_channel || "unknown").toLowerCase();

        if (!byCategory[cat]) byCategory[cat] = 0;
        byCategory[cat] += amt;

        if (!byChain[chain]) byChain[chain] = 0;
        byChain[chain] += amt;

        if (!byChannel[channel]) byChannel[channel] = 0;
        byChannel[channel] += amt;
      });

      const lines = [];
      lines.push("By category (sum of base amounts):");
      Object.keys(byCategory).sort().forEach(cat => {
        lines.push(`‚Ä¢ ${cat}: ${byCategory[cat].toFixed(2)}`);
      });

      lines.push("");
      lines.push("By chain (sum of base amounts):");
      Object.keys(byChain).sort().forEach(ch => {
        lines.push(`‚Ä¢ ${ch}: ${byChain[ch].toFixed(2)}`);
      });

      lines.push("");
      lines.push("By payment channel (sum of base amounts):");
      Object.keys(byChannel).sort().forEach(ch => {
        lines.push(`‚Ä¢ ${ch}: ${byChannel[ch].toFixed(2)}`);
      });

      return lines.join("\n");
    }

    function buildFxOverview(result) {
      if (!result || !Array.isArray(result.entries)) return "(no FX data yet)";
      const entries = result.entries;
      const perFx = {};

      entries.forEach(e => {
        const fx = e.fx || null;
        if (!fx || !fx.fx_currency) return;
        const cur = fx.fx_currency.toUpperCase();
        if (!perFx[cur]) {
          perFx[cur] = {
            count: 0,
            fx_amount: 0,
            base_from_fx: 0,
            recorded_base: 0,
            fx_fee: 0,
            fx_diff: 0
          };
        }
        const b = perFx[cur];
        b.count++;
        b.fx_amount += Number(fx.fx_amount || 0);
        b.base_from_fx += Number(fx.base_amount_from_fx || 0);
        b.recorded_base += Number(fx.recorded_base_amount || 0);
        b.fx_fee += Number(fx.fx_fee || 0);
        b.fx_diff += Number(fx.fx_diff || 0);
      });

      const keys = Object.keys(perFx);
      if (!keys.length) return "(no FX data yet)";
      const lines = [];
      keys.sort().forEach(cur => {
        const b = perFx[cur];
        lines.push(
          `${cur}: tx=${b.count}, fx_amount=${b.fx_amount.toFixed(2)}, base_from_fx=${b.base_from_fx.toFixed(2)}, recorded_base=${b.recorded_base.toFixed(2)}, fx_fee=${b.fx_fee.toFixed(2)}, fx_diff=${b.fx_diff.toFixed(2)}`
        );
      });
      return lines.join("\n");
    }

    function buildInsights(result) {
      if (!result || !Array.isArray(result.entries)) return "(no insights yet)";
      const entries = result.entries;
      if (!entries.length) return "(no insights yet)";

      const summary = result.summary || {};
      const totalTx = summary.total_transactions ?? entries.length;
      const totalIn = Number(summary.total_inflows || 0);
      const totalOut = Number(summary.total_outflows || 0);
      const net = totalIn - totalOut;

      const perCountry = {};
      const perFx = {};
      const perChain = {};
      const perChannel = {};

      entries.forEach(e => {
        const amt = Number(e.amount || 0);
        const dir = e.direction || null;
        const inflowAmt = dir === "in" ? amt : 0;
        const outflowAmt = dir === "out" ? amt : 0;

        const country = e.tax_country || "Unknown";
        if (!perCountry[country]) {
          perCountry[country] = { count: 0, inflows: 0, outflows: 0, vat: 0, wht: 0 };
        }
        const c = perCountry[country];
        c.count++;
        c.inflows += inflowAmt;
        c.outflows += outflowAmt;
        if (e.tax_analysis) {
          c.vat += Number(e.tax_analysis.vat_amount || 0);
          c.wht += Number(e.tax_analysis.withholding_tax_amount || 0);
        }

        const fx = e.fx || null;
        if (fx && fx.fx_currency) {
          const cur = fx.fx_currency.toUpperCase();
          if (!perFx[cur]) {
            perFx[cur] = { count: 0, fx_amount: 0, recorded_base: 0 };
          }
          const f = perFx[cur];
          f.count++;
          if (fx.fx_amount != null) f.fx_amount += Number(fx.fx_amount) || 0;
          if (fx.recorded_base_amount != null) f.recorded_base += Number(fx.recorded_base_amount) || 0;
        }

        const chain = (e.chain || "OFFCHAIN").toUpperCase();
        if (!perChain[chain]) perChain[chain] = { count: 0, volume: 0 };
        perChain[chain].count++;
        perChain[chain].volume += amt;

        const channel = (e.payment_channel || "unknown").toLowerCase();
        if (!perChannel[channel]) perChannel[channel] = { count: 0, volume: 0 };
        perChannel[channel].count++;
        perChannel[channel].volume += amt;
      });

      function topBy(obj, field) {
        const keys = Object.keys(obj);
        if (!keys.length) return null;
        return keys.map(k => ({ key: k, ...obj[k] }))
          .sort((a, b) => (b[field] || 0) - (a[field] || 0))[0];
      }

      const topCountry = topBy(perCountry, "inflows");
      const topFx = topBy(perFx, "recorded_base");
      const topChain = topBy(perChain, "volume");
      const topChannel = topBy(perChannel, "volume");

      const lines = [];
      lines.push("Ace Insights ‚Äì Draft Narrative Seed");
      lines.push("==================================");
      lines.push("");
      lines.push("1) Executive Snapshot");
      lines.push(
        `‚Ä¢ Transactions processed: ${totalTx} | Total inflows: ${totalIn.toFixed(2)} | Total outflows: ${totalOut.toFixed(2)} | Net: ${net.toFixed(2)}`
      );
      if (topCountry) {
        lines.push(
          `‚Ä¢ Most active tax country: ${topCountry.key} (inflows: ${topCountry.inflows.toFixed(2)}, outflows: ${topCountry.outflows.toFixed(2)})`
        );
      }
      if (topFx) {
        lines.push(
          `‚Ä¢ Main FX currency: ${topFx.key} (fx amount: ${topFx.fx_amount.toFixed(2)}, base volume: ${topFx.recorded_base.toFixed(2)})`
        );
      }
      if (topChain) {
        lines.push(
          `‚Ä¢ Dominant chain: ${topChain.key} (volume: ${topChain.volume.toFixed(2)})`
        );
      }
      if (topChannel) {
        lines.push(
          `‚Ä¢ Key payment channel: ${topChannel.key} (volume: ${topChannel.volume.toFixed(2)})`
        );
      }

      lines.push("");
      lines.push("2) Tax & Compliance Signals");
      const countryKeys = Object.keys(perCountry).sort();
      if (!countryKeys.length) {
        lines.push("‚Ä¢ No tax country breakdown available.");
      } else {
        countryKeys.forEach(ct => {
          const c = perCountry[ct];
          lines.push(
            `‚Ä¢ ${ct}: VAT = ${c.vat.toFixed(2)}, WHT = ${c.wht.toFixed(2)}, tx = ${c.count}, net = ${(c.inflows - c.outflows).toFixed(2)}`
          );
        });
      }

      lines.push("");
      lines.push("3) FX Exposure View");
      const fxKeys = Object.keys(perFx);
      if (!fxKeys.length) {
        lines.push("‚Ä¢ No FX-tagged transactions in this dataset.");
      } else {
        fxKeys.sort().forEach(cur => {
          const f = perFx[cur];
          lines.push(
            `‚Ä¢ ${cur}: fx_amount=${f.fx_amount.toFixed(2)}, recorded_base=${f.recorded_base.toFixed(2)}`
          );
        });
      }

      lines.push("");
      lines.push("4) Channels & Chains Focus");
      const chainKeys = Object.keys(perChain).sort();
      if (chainKeys.length) {
        lines.push("‚Ä¢ Chains:");
        chainKeys.forEach(ch => {
          const b = perChain[ch];
          lines.push(`   - ${ch}: tx=${b.count}, volume=${b.volume.toFixed(2)}`);
        });
      }
      const chanKeys = Object.keys(perChannel).sort();
      if (chanKeys.length) {
        lines.push("‚Ä¢ Payment channels:");
        chanKeys.forEach(ch => {
          const b = perChannel[ch];
          lines.push(`   - ${ch}: tx=${b.count}, volume=${b.volume.toFixed(2)}`);
        });
      }

      lines.push("");
      lines.push("5) X / Twitter Draft Seed");
      lines.push("");
      lines.push("Hook: Today‚Äôs ledger tells a deeper story than just numbers.");
      lines.push(
        `Body: We processed ${totalTx} transactions across ${countryKeys.length || 1} tax jurisdictions, with net cash flow of ${net.toFixed(2)} in base currency.` +
        (topChain ? ` On-chain activity on ${topChain.key} is emerging as a key rail,` : "") +
        (topFx ? ` while ${topFx.key} remains the primary FX exposure.` : "")
      );
      lines.push(
        "CTA: If you‚Äôre not reading your on-chain and FX flows like a story, you‚Äôre leaving strategy on the table."
      );
      lines.push("");
      lines.push("‚Üí Copy this into Ace Insights Writer AI or ChatGPT to generate GM posts, threads, communiques and reports.");

      return lines.join("\n");
    }

    // ----------------------------
    // Event handlers ‚Äì Profile & Capture
    // ----------------------------
    applyPresetBtn.addEventListener("click", () => {
      const val = profilePresetEl.value;
      if (!val) return;
      if (val === "ng-retail") {
        businessProfile.business_name = "Ace Hybrid Retail & Web3 Hub";
        businessProfile.industry = "Retail & Digital Services";
        businessProfile.country = "Nigeria";
        businessProfile.base_currency = "NGN";
        defaultTaxCountryCode = "NG";
      } else if (val === "us-saas") {
        businessProfile.business_name = "Ace Digital Intelligence Inc.";
        businessProfile.industry = "SaaS & Information Services";
        businessProfile.country = "United States";
        businessProfile.base_currency = "USD";
        defaultTaxCountryCode = "US";
      } else if (val === "uk-consult") {
        businessProfile.business_name = "Ace Insights Consulting Ltd";
        businessProfile.industry = "Consulting & Advisory";
        businessProfile.country = "United Kingdom";
        businessProfile.base_currency = "GBP";
        defaultTaxCountryCode = "UK";
      }
      renderProfileToForm();
      profileStatusEl.textContent = "Preset applied. Click Save Profile to persist.";
      setTimeout(() => { profileStatusEl.textContent = ""; }, 3000);
    });

    saveProfileBtn.addEventListener("click", () => {
      businessProfile.business_name = bizNameEl.value.trim();
      businessProfile.industry = bizIndustryEl.value.trim();
      businessProfile.country = bizCountryEl.value.trim();
      businessProfile.base_currency = baseCurrencyEl.value.trim() || "NGN";
      defaultTaxCountryCode = defaultTaxCountryEl.value.trim() || "NG";
      saveProfileToStorage();
      profileStatusEl.textContent = "Profile saved.";
      setTimeout(() => { profileStatusEl.textContent = ""; }, 3000);
    });

    addTxBtn.addEventListener("click", () => {
      const date = txDateEl.value || null;
      const direction = txDirectionEl.value === "out" ? "out" : "in";
      const amount = Number(txAmountEl.value || 0);
      const currency = txCurrencyEl.value.trim() || (businessProfile.base_currency || "NGN");
      const description = txDescriptionEl.value.trim();
      const payment_channel = txChannelEl.value || "";
      const chain = txChainEl.value || "";
      const tax_country = (txTaxCountryEl.value || defaultTaxCountryEl.value || defaultTaxCountryCode || "NG").toUpperCase();
      const counterparty_type = txCounterpartyEl.value || "";

      if (!amount || !description) {
        txStatusEl.textContent = "Please enter at least amount and description.";
        return;
      }

      const fx_currency = fxCurrencyEl.value.trim();
      const fx_amount = fxAmountEl.value ? Number(fxAmountEl.value) : null;
      const fx_rate = fxRateEl.value ? Number(fxRateEl.value) : null;
      const fx_fee = fxFeeEl.value ? Number(fxFeeEl.value) : null;

      const baseTx = {
        id: txIdEl.value.trim() || "TX-" + (sessionTransactions.length + 1),
        date,
        amount,
        currency,
        description,
        direction,
        counterparty_type,
        payment_channel: payment_channel || "other",
        tax_country
      };

      if (chain) baseTx.chain = chain;
      if (fx_currency || fx_amount || fx_rate || fx_fee) {
        baseTx.fx_currency = fx_currency || currency;
        if (fx_amount != null && !isNaN(fx_amount)) baseTx.fx_amount = fx_amount;
        if (fx_rate != null && !isNaN(fx_rate)) baseTx.fx_rate_to_base = fx_rate;
        if (fx_fee != null && !isNaN(fx_fee)) baseTx.fx_fee = fx_fee;
      }

      sessionTransactions.push(baseTx);
      saveTxToStorage();
      renderTransactionsTable();

      txStatusEl.textContent = "Payment added to session.";
      setTimeout(() => { txStatusEl.textContent = ""; }, 2500);

      txAmountEl.value = "";
      txDescriptionEl.value = "";
      txIdEl.value = "";
    });

    clearTxFormBtn.addEventListener("click", () => {
      txDateEl.value = "";
      txDirectionEl.value = "in";
      txAmountEl.value = "";
      txCurrencyEl.value = "";
      txDescriptionEl.value = "";
      txChannelEl.value = "";
      txChainEl.value = "";
      txTaxCountryEl.value = "";
      txCounterpartyEl.value = "";
      txIdEl.value = "";
      fxCurrencyEl.value = "";
      fxAmountEl.value = "";
      fxRateEl.value = "";
      fxFeeEl.value = "";
      txStatusEl.textContent = "";
    });

    loadSampleTxBtn.addEventListener("click", () => {
      const sample = [
        {
          id: "PI-DEMO-001",
          date: new Date().toISOString().slice(0,10),
          amount: 60000,
          currency: "NGN",
          description: "In-store Pi payment for groceries",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pi",
          chain: "pi",
          tax_country: (defaultTaxCountryEl.value || "NG").toUpperCase(),
          fx_currency: "PI",
          fx_amount: 60,
          fx_rate_to_base: 1000,
          fx_fee: 0
        },
        {
          id: "BINANCE-DEMO-001",
          date: new Date().toISOString().slice(0,10),
          amount: 750000,
          currency: "NGN",
          description: "USDT deposit from Binance",
          direction: "in",
          counterparty_type: "exchange",
          payment_channel: "binance",
          chain: "bsc",
          tax_country: (defaultTaxCountryEl.value || "NG").toUpperCase(),
          fx_currency: "USDT",
          fx_amount: 500,
          fx_rate_to_base: 1500,
          fx_fee: 0
        },
        {
          id: "AMAZON-DEMO-001",
          date: new Date().toISOString().slice(0,10),
          amount: 320000,
          currency: "NGN",
          description: "Electronics for office purchased on Amazon",
          direction: "out",
          counterparty_type: "merchant",
          payment_channel: "amazon",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 200,
          fx_rate_to_base: 1600,
          fx_fee: 0
        }
      ];
      sessionTransactions = sessionTransactions.concat(sample);
      saveTxToStorage();
      renderTransactionsTable();
      txStatusEl.textContent = "Sample transactions added.";
      setTimeout(() => { txStatusEl.textContent = ""; }, 2500);
    });

    clearAllBtn.addEventListener("click", () => {
      if (!sessionTransactions.length) return;
      if (!confirm("Clear all captured payments in this session?")) return;
      sessionTransactions = [];
      saveTxToStorage();
      renderTransactionsTable();
      payloadStatusEl.textContent = "";
    });

    // ----------------------------
    // Payload actions
    // ----------------------------
    buildPayloadBtn.addEventListener("click", () => {
      if (!sessionTransactions.length) {
        payloadStatusEl.textContent = "No captured payments yet ‚Äì add at least one or load sample transactions.";
        return;
      }
      const payload = buildAcePiPayloadFromCaptured();
      payloadInput.value = JSON.stringify(payload, null, 2);
      payloadStatusEl.textContent = "AcePi payload generated from captured ledger.";
      setTimeout(() => { payloadStatusEl.textContent = ""; }, 3000);
    });

    loadDemoBtn.addEventListener("click", () => {
      payloadInput.value = JSON.stringify(masterDemoPayload, null, 2);
      payloadStatusEl.textContent = "Master demo payload loaded.";
      setTimeout(() => { payloadStatusEl.textContent = ""; }, 3000);
    });

    clearPayloadBtn.addEventListener("click", () => {
      payloadInput.value = "";
      payloadStatusEl.textContent = "";
    });

    // ----------------------------
    // Engine actions
    // ----------------------------
    runBtn.addEventListener("click", () => {
      const raw = payloadInput.value.trim();
      if (!raw) {
        statusEl.textContent = "Please build a payload from captured ledger, load the demo, or paste your own JSON.";
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        statusEl.textContent = "Payload is not valid JSON: " + e.message;
        return;
      }

      try {
        const result = acepiLiteEngine(parsed);
        lastResult = result;
        outputEl.textContent = JSON.stringify(result, null, 2);
        summaryEl.textContent = buildSummary(result);
        analyticsEl.textContent = buildAnalytics(result);
        fxOverviewEl.textContent = buildFxOverview(result);
        insightsEl.textContent = buildInsights(result);
        statusEl.textContent = "Done. AcePi Lite output, summary, analytics, FX overview and insights generated.";
        downloadBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = "Error running AcePi Lite: " + err.message;
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!lastResult) return;
      const blob = new Blob([JSON.stringify(lastResult, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().replace(/[-:T.Z]/g, "").slice(0, 14);
      a.href = url;
      a.download = `acepi-suite-output-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ----------------------------
    // Init
    // ----------------------------
    (function init() {
      loadFromStorage();
      renderProfileToForm();
      renderTransactionsTable();
      outputEl.textContent = "(no output yet)";
      summaryEl.textContent = "(no summary yet)";
      analyticsEl.textContent = "(no analytics yet)";
      fxOverviewEl.textContent = "(no FX data yet)";
      insightsEl.textContent = "(no insights yet)";
    })();
  </script>
</body>
</html>
