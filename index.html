<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AcePi Lite ‚Äì Hybrid Accounting & Tax Intelligence Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      padding: 16px 24px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header span {
      font-size: 12px;
      opacity: 0.8;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      grid-gap: 16px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .card h2 {
      margin-top: 0;
      font-size: 16px;
    }
    .card h3 {
      font-size: 14px;
      margin-bottom: 6px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    textarea {
      width: 100%;
      min-height: 220px;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      box-sizing: border-box;
      resize: vertical;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 8px;
      margin-top: 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    pre {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #111827;
      padding: 10px;
      font-size: 11px;
      max-height: 240px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .status {
      font-size: 12px;
      margin-top: 8px;
      min-height: 18px;
      opacity: 0.9;
    }
    .muted {
      opacity: 0.8;
      font-size: 12px;
    }
    a.small-link {
      font-size: 11px;
      color: #38bdf8;
      text-decoration: none;
    }
    a.small-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>AcePi Lite</h1>
      <span>Hybrid accounting, tax, FX & chain intelligence ‚Äì browser prototype</span>
    </div>
    <div style="text-align:right;font-size:11px;opacity:0.8;">
      Ace Consulting & Analytics (ACA)<br />
      AcePi ‚Üí ACA Control Room ‚Üí Ace Insights
    </div>
  </header>

  <main>
    <section class="card">
      <h2>1. Input Payload (JSON)</h2>
      <p class="muted">
        Paste a payload with <code>business_profile</code>, <code>tax_profile</code>,
        <code>chart_of_accounts</code> and <code>transactions[]</code> ‚Äì or click
        ‚ÄúLoad Demo Payload (Master Dataset)‚Äù to use the embedded multi-country test set.
      </p>

      <label for="payloadInput">AcePi Payload JSON</label>
      <textarea id="payloadInput" placeholder="{ &quot;business_profile&quot;: { ... }, &quot;transactions&quot;: [ ... ] }"></textarea>

      <div style="margin-top:8px;">
        <button id="loadDemoBtn">üß™ Load Demo Payload (Master Dataset)</button>
        <button id="clearBtn" class="btn-secondary">Clear</button>
      </div>

      <div class="status" id="status"></div>

      <p class="muted" style="margin-top:10px;">
        Next steps:
        <br />1Ô∏è‚É£ Adjust or paste your own payload if needed.
        <br />2Ô∏è‚É£ Click <strong>Run AcePi Lite</strong> to classify & generate ledger output.
        <br />3Ô∏è‚É£ Use the downloaded JSON in
        <a class="small-link" href="https://peteranalytica.github.io/ACA-ControlRoom/" target="_blank">ACA Control Room</a>
        or
        <a class="small-link" href="https://peteranalytica.github.io/AceInsights/" target="_blank">Ace Insights</a>.
      </p>
    </section>

    <section class="card">
      <h2>2. AcePi Output & Views</h2>
      <div style="margin-bottom:8px;">
        <button id="runBtn">‚ñ∂ Run AcePi Lite</button>
        <button id="downloadBtn" class="btn-secondary" disabled>‚¨á Download JSON Output</button>
      </div>

      <h3>Raw AcePi Output (JSON)</h3>
      <pre id="output">(no output yet)</pre>

      <h3 style="margin-top:16px;font-size:14px;">Summary View</h3>
      <pre id="summary">(no summary yet)</pre>

      <h3 style="margin-top:16px;font-size:14px;">Analytics View (categories, chains, channels)</h3>
      <pre id="analytics">(no analytics yet)</pre>

      <h3 style="margin-top:16px;font-size:14px;">FX Overview</h3>
      <pre id="fxOverview">(no FX data yet)</pre>

      <h3 style="margin-top:16px;font-size:14px;">Insights (auto-generated draft)</h3>
      <pre id="insights">(no insights yet)</pre>
    </section>
  </main>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Master demo payload ‚Äì multi-country, FX, Pi, Base, exchanges & merchants
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const masterDemoPayload = {
      business_profile: {
        business_name: "Ace Hybrid Retail & Web3 Hub",
        industry: "Retail & Digital Services",
        country: "Nigeria",
        base_currency: "NGN"
      },
      tax_profile: {
        country: "NG",
        vat_applicable: true,
        vat_registered: true,
        vat_rate: 0.075,
        treat_sales_as_vat_inclusive: true,
        withholding_tax_enabled: true,
        default_wht_service_rate: 0.10,
        default_wht_contract_rate: 0.05,
        default_wht_rent_rate: 0.10,
        input_vat_claimable: true
      },
      chart_of_accounts: [
        { code: "1000", name: "Cash and Bank", type: "asset" },
        { code: "1010", name: "On-chain Wallet - Base (USDC)", type: "asset" },
        { code: "1011", name: "On-chain Wallet - Pi", type: "asset" },
        { code: "2000", name: "Accounts Payable", type: "liability" },
        { code: "3000", name: "Owner's Equity", type: "equity" },
        { code: "4000", name: "Sales Revenue (Local)", type: "income" },
        { code: "4010", name: "Sales Revenue (On-chain)", type: "income" },
        { code: "4011", name: "Sales Revenue (Pi Network)", type: "income" },
        { code: "5000", name: "Cost of Goods Sold", type: "expense" },
        { code: "6001", name: "Office & Shop Expenses", type: "expense" },
        { code: "6002", name: "Professional Fees Expense", type: "expense" },
        { code: "6003", name: "Rent Expense", type: "expense" },
        { code: "6005", name: "Network Fees (Gas)", type: "expense" },
        { code: "9999", name: "Unclassified Transaction", type: "expense" }
      ],
      transactions: [
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Base local retail + on-chain demo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {
          id: "DEM-001",
          date: "2025-11-20",
          amount: 350000,
          currency: "NGN",
          description: "In-store POS sales for the day",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pos",
          tax_country: "NG"
        },
        {
          id: "DEM-002",
          date: "2025-11-20",
          amount: 145000,
          currency: "NGN",
          description: "Inventory purchase from local supplier (wholesale goods)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-003",
          date: "2025-11-21",
          amount: 25000,
          currency: "NGN",
          description: "Office rent for November (shop space)",
          direction: "out",
          counterparty_type: "landlord",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-004",
          date: "2025-11-21",
          amount: 42000,
          currency: "NGN",
          description: "Payment to freelance graphic designer for marketing flyers",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-005",
          date: "2025-11-22",
          amount: 180000,
          currency: "NGN",
          description: "Online sales paid via bank transfer (Jumia-like order)",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "bank_transfer",
          tax_country: "NG"
        },
        {
          id: "DEM-006",
          date: "2025-11-23",
          amount: 300,
          currency: "USDC",
          description: "Online order paid in USDC on Base",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "onchain",
          chain: "base",
          tx_hash: "0xbase300usdcin",
          wallet_address: "0xHybridStoreWallet",
          counterparty_wallet: "0xCustomerWallet1",
          contract_address: null,
          token_symbol: "USDC",
          token_decimal: 6,
          gas_fee: 0.00025,
          gas_currency: "ETH",
          tax_country: "NG"
        },
        {
          id: "DEM-007",
          date: "2025-11-23",
          amount: 120,
          currency: "USDC",
          description: "Payment to web developer in USDC for website update",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "onchain",
          chain: "base",
          tx_hash: "0xbase120usdcout",
          wallet_address: "0xHybridStoreWallet",
          counterparty_wallet: "0xDeveloperWallet",
          contract_address: null,
          token_symbol: "USDC",
          token_decimal: 6,
          gas_fee: 0.00030,
          gas_currency: "ETH",
          tax_country: "NG"
        },
        {
          id: "DEM-008",
          date: "2025-11-23",
          amount: 0.0003,
          currency: "ETH",
          description: "Gas fee for USDC payment to web developer on Base",
          direction: "out",
          counterparty_type: "network",
          payment_channel: "onchain",
          chain: "base",
          tx_hash: "0xbase120usdcout",
          wallet_address: "0xHybridStoreWallet",
          counterparty_wallet: null,
          contract_address: null,
          token_symbol: "ETH",
          token_decimal: 18,
          gas_fee: 0.00030,
          gas_currency: "ETH",
          tax_country: "NG"
        },
        {
          id: "DEM-009",
          date: "2025-11-24",
          amount: 60,
          currency: "PI",
          description: "Sale of goods paid with Pi Network at physical store",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pi",
          chain: "pi",
          tx_hash: "0xpi60sale",
          wallet_address: "PiBusinessWalletAddress",
          counterparty_wallet: "PiCustomerWallet1",
          contract_address: null,
          token_symbol: "PI",
          token_decimal: 8,
          gas_fee: 0,
          gas_currency: "PI",
          tax_country: "NG"
        },
        {
          id: "DEM-010",
          date: "2025-11-24",
          amount: 15,
          currency: "PI",
          description: "Small business service payment to local technician in Pi",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "pi",
          chain: "pi",
          tx_hash: "0xpi15service",
          wallet_address: "PiBusinessWalletAddress",
          counterparty_wallet: "PiTechnicianWallet",
          contract_address: null,
          token_symbol: "PI",
          token_decimal: 8,
          gas_fee: 0,
          gas_currency: "PI",
          tax_country: "NG"
        },

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FX + Professional exams & education ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {
          id: "FX-ACCA-GBP-001",
          date: "2025-12-01",
          amount: 1800000,
          currency: "NGN",
          description: "ACCA annual subscription (GBP payment, converted to NGN)",
          direction: "out",
          counterparty_type: "professional_body",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "GBP",
          fx_amount: 1000,
          fx_rate_to_base: 1800,
          fx_fee: 0
        },
        {
          id: "FX-CPA-USD-001",
          date: "2025-12-01",
          amount: 2250000,
          currency: "NGN",
          description: "CPA US annual dues (USD, FX fee included separately)",
          direction: "out",
          counterparty_type: "professional_body",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "USD",
          fx_amount: 1500,
          fx_rate_to_base: 1500,
          fx_fee: 5000
        },
        {
          id: "FX-ICAN-NGN-001",
          date: "2025-12-02",
          amount: 180000,
          currency: "NGN",
          description: "ICAN exam registration (NGN local payment)",
          direction: "out",
          counterparty_type: "professional_body",
          payment_channel: "card",
          tax_country: "NG",
          fx_currency: "NGN",
          fx_amount: 180000,
          fx_rate_to_base: 1,
          fx_fee: 0
        },
        {
          id: "FX-ICAN-USD-001",
          date: "2025-12-02",
          amount: 950000,
          currency: "NGN",
          description: "ICAN fees paid from diaspora in USD (converted to NGN)",
          direction: "out",
          counterparty_type: "professional_body",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "USD",
          fx_amount: 1000,
          fx_rate_to_base: 950,
          fx_fee: 2500
        },
        {
          id: "FX-ICAN-GBP-001",
          date: "2025-12-02",
          amount: 1200000,
          currency: "NGN",
          description: "ICAN fees in GBP (UK-based student)",
          direction: "out",
          counterparty_type: "professional_body",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "GBP",
          fx_amount: 800,
          fx_rate_to_base: 1500,
          fx_fee: 3000
        },
        {
          id: "FX-CFA-USD-001",
          date: "2025-12-03",
          amount: 4500000,
          currency: "NGN",
          description: "CFA exam + registration (USD, FX conversion to NGN)",
          direction: "out",
          counterparty_type: "exam_body",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "USD",
          fx_amount: 3000,
          fx_rate_to_base: 1500,
          fx_fee: 10000
        },
        {
          id: "FX-SAT-USD-001",
          date: "2025-12-03",
          amount: 300000,
          currency: "NGN",
          description: "SAT exam fee (USD, NG student)",
          direction: "out",
          counterparty_type: "exam_body",
          payment_channel: "card",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 200,
          fx_rate_to_base: 1500,
          fx_fee: 2500
        },
        {
          id: "FX-TOEFL-USD-001",
          date: "2025-12-03",
          amount: 375000,
          currency: "NGN",
          description: "TOEFL exam fee (USD, NG student)",
          direction: "out",
          counterparty_type: "exam_body",
          payment_channel: "card",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 250,
          fx_rate_to_base: 1500,
          fx_fee: 3000
        },
        {
          id: "FX-UNI-UK-001",
          date: "2025-12-05",
          amount: 18000000,
          currency: "NGN",
          description: "UK university MBA tuition (GBP ‚Üí NGN)",
          direction: "out",
          counterparty_type: "education_institution",
          payment_channel: "bank_transfer",
          tax_country: "UK",
          fx_currency: "GBP",
          fx_amount: 15000,
          fx_rate_to_base: 1200,
          fx_fee: 50000
        },
        {
          id: "FX-SECONDARY-NG-001",
          date: "2025-12-05",
          amount: 350000,
          currency: "NGN",
          description: "Local secondary school fees (NGN)",
          direction: "out",
          counterparty_type: "education_institution",
          payment_channel: "bank_transfer",
          tax_country: "NG",
          fx_currency: "NGN",
          fx_amount: 350000,
          fx_rate_to_base: 1,
          fx_fee: 0
        },

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Exchanges & on-chain wallets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {
          id: "EX-BINANCE-IN-001",
          date: "2025-12-06",
          amount: 750000,
          currency: "NGN",
          description: "USDT deposit from Binance to business wallet (estimated NGN)",
          direction: "in",
          counterparty_type: "exchange",
          payment_channel: "binance",
          chain: "bsc",
          token_symbol: "USDT",
          gas_fee: 0.0003,
          gas_currency: "BNB",
          tax_country: "NG",
          fx_currency: "USDT",
          fx_amount: 500,
          fx_rate_to_base: 1500,
          fx_fee: 0
        },
        {
          id: "EX-BINANCE-OUT-001",
          date: "2025-12-06",
          amount: 600000,
          currency: "NGN",
          description: "USDT withdrawal to Binance from business wallet",
          direction: "out",
          counterparty_type: "exchange",
          payment_channel: "binance",
          chain: "bsc",
          token_symbol: "USDT",
          gas_fee: 0.00025,
          gas_currency: "BNB",
          tax_country: "NG",
          fx_currency: "USDT",
          fx_amount: 400,
          fx_rate_to_base: 1500,
          fx_fee: 0
        },
        {
          id: "EX-BYBIT-IN-001",
          date: "2025-12-07",
          amount: 450000,
          currency: "NGN",
          description: "Income from trading profits moved from Bybit to business",
          direction: "in",
          counterparty_type: "exchange",
          payment_channel: "bybit",
          chain: "eth",
          token_symbol: "USDT",
          gas_fee: 0.00021,
          gas_currency: "ETH",
          tax_country: "NG",
          fx_currency: "USDT",
          fx_amount: 300,
          fx_rate_to_base: 1500,
          fx_fee: 0
        },
        {
          id: "EX-OKX-OUT-001",
          date: "2025-12-07",
          amount: 200000,
          currency: "NGN",
          description: "Payment to supplier via OKX (USDT onchain)",
          direction: "out",
          counterparty_type: "exchange",
          payment_channel: "okx",
          chain: "eth",
          token_symbol: "USDT",
          gas_fee: 0.00019,
          gas_currency: "ETH",
          tax_country: "NG",
          fx_currency: "USDT",
          fx_amount: 130,
          fx_rate_to_base: 1538.46,
          fx_fee: 0
        },
        {
          id: "WAL-METAMASK-BASE-001",
          date: "2025-12-08",
          amount: 225000,
          currency: "NGN",
          description: "Payment to web developer via MetaMask on Base (USDC)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "metamask",
          chain: "base",
          token_symbol: "USDC",
          gas_fee: 0.00032,
          gas_currency: "ETH",
          tax_country: "NG",
          fx_currency: "USDC",
          fx_amount: 150,
          fx_rate_to_base: 1500,
          fx_fee: 0
        },
        {
          id: "WAL-TON-001",
          date: "2025-12-08",
          amount: 150000,
          currency: "NGN",
          description: "TON payment received from customer",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "ton",
          chain: "ton",
          token_symbol: "TON",
          gas_fee: 0.02,
          gas_currency: "TON",
          tax_country: "NG",
          fx_currency: "TON",
          fx_amount: 300,
          fx_rate_to_base: 500,
          fx_fee: 0
        },

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Merchants & subscriptions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {
          id: "MER-AMAZON-INV-001",
          date: "2025-12-09",
          amount: 320000,
          currency: "NGN",
          description: "Electronics for office purchased on Amazon (USD)",
          direction: "out",
          counterparty_type: "merchant",
          payment_channel: "amazon",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 200,
          fx_rate_to_base: 1600,
          fx_fee: 0
        },
        {
          id: "MER-ALIBABA-INV-001",
          date: "2025-12-09",
          amount: 1450000,
          currency: "NGN",
          description: "Bulk inventory purchased on Alibaba (USD)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "alibaba",
          tax_country: "CN",
          fx_currency: "USD",
          fx_amount: 1000,
          fx_rate_to_base: 1450,
          fx_fee: 0
        },
        {
          id: "MER-WIX-SUB-001",
          date: "2025-12-10",
          amount: 49000,
          currency: "NGN",
          description: "Monthly Wix website subscription (USD)",
          direction: "out",
          counterparty_type: "merchant",
          payment_channel: "wix",
          tax_country: "IL",
          fx_currency: "USD",
          fx_amount: 49,
          fx_rate_to_base: 1000,
          fx_fee: 0
        },
        {
          id: "MER-NVIDIA-GPU-001",
          date: "2025-12-10",
          amount: 1200000,
          currency: "NGN",
          description: "NVIDIA GPU purchase for AI workloads (USD)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "nvidia",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 800,
          fx_rate_to_base: 1500,
          fx_fee: 5000
        },
        {
          id: "MER-INVESTOPEDIA-SUB-001",
          date: "2025-12-11",
          amount: 39000,
          currency: "NGN",
          description: "Investopedia Pro subscription (USD)",
          direction: "out",
          counterparty_type: "information_service",
          payment_channel: "investopedia",
          tax_country: "US",
          fx_currency: "USD",
          fx_amount: 39,
          fx_rate_to_base: 1000,
          fx_fee: 0
        },

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Pi Network ‚Äì income + expense ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        {
          id: "PI-PAYMENT-STORE-001",
          date: "2025-12-11",
          amount: 60000,
          currency: "NGN",
          description: "In-store Pi Network payment for goods (valued in NGN)",
          direction: "in",
          counterparty_type: "customer",
          payment_channel: "pi",
          chain: "pi",
          token_symbol: "PI",
          tax_country: "NG",
          fx_currency: "PI",
          fx_amount: 60,
          fx_rate_to_base: 1000,
          fx_fee: 0
        },
        {
          id: "PI-SERVICE-TECH-001",
          date: "2025-12-11",
          amount: 15000,
          currency: "NGN",
          description: "Service payment to local technician in Pi (valued in NGN)",
          direction: "out",
          counterparty_type: "supplier",
          payment_channel: "pi",
          chain: "pi",
          token_symbol: "PI",
          tax_country: "NG",
          fx_currency: "PI",
          fx_amount: 15,
          fx_rate_to_base: 1000,
          fx_fee: 0
        }
      ]
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // DOM elements
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const payloadInput = document.getElementById("payloadInput");
    const loadDemoBtn = document.getElementById("loadDemoBtn");
    const clearBtn = document.getElementById("clearBtn");
    const runBtn = document.getElementById("runBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    const outputEl = document.getElementById("output");
    const summaryEl = document.getElementById("summary");
    const analyticsEl = document.getElementById("analytics");
    const fxOverviewEl = document.getElementById("fxOverview");
    const insightsEl = document.getElementById("insights");
    const statusEl = document.getElementById("status");

    let lastResult = null;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // UI actions
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loadDemoBtn.addEventListener("click", () => {
      payloadInput.value = JSON.stringify(masterDemoPayload, null, 2);
      statusEl.textContent = "Demo payload loaded. You can adjust it or run AcePi Lite directly.";
    });

    clearBtn.addEventListener("click", () => {
      payloadInput.value = "";
      outputEl.textContent = "(no output yet)";
      summaryEl.textContent = "(no summary yet)";
      analyticsEl.textContent = "(no analytics yet)";
      fxOverviewEl.textContent = "(no FX data yet)";
      insightsEl.textContent = "(no insights yet)";
      statusEl.textContent = "";
      lastResult = null;
      downloadBtn.disabled = true;
    });

    runBtn.addEventListener("click", () => {
      const raw = payloadInput.value.trim();
      if (!raw) {
        statusEl.textContent = "Please paste a payload or load the demo first.";
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        statusEl.textContent = "Payload is not valid JSON: " + e.message;
        return;
      }

      try {
        const result = acepiLiteEngine(parsed);
        lastResult = result;
        outputEl.textContent = JSON.stringify(result, null, 2);
        summaryEl.textContent = buildSummary(result);
        analyticsEl.textContent = buildAnalytics(result);
        fxOverviewEl.textContent = buildFxOverview(result);
        insightsEl.textContent = buildInsights(result);
        statusEl.textContent = "Done. AcePi Lite output, summary, analytics, FX overview and insights generated.";
        downloadBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = "Error running AcePi Lite: " + err.message;
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!lastResult) return;
      const blob = new Blob([JSON.stringify(lastResult, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().replace(/[-:T.Z]/g, "").slice(0, 14);
      a.href = url;
      a.download = `acepi-output-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Core AcePi Lite engine
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function acepiLiteEngine(payload) {
      const business_profile = payload.business_profile || {};
      const tax_profile = payload.tax_profile || {};
      const baseCurrency = business_profile.base_currency || "NGN";

      const txs = Array.isArray(payload.transactions) ? payload.transactions : [];

      const entries = [];
      let totalIn = 0;
      let totalOut = 0;

      txs.forEach(tx => {
        const direction = tx.direction === "out" ? "out" : "in";
        const rawAmount = Number(tx.amount || 0);
        const txCurrency = tx.currency || baseCurrency;

        // Basic FX logic
        const fx = {};
        if (tx.fx_currency && tx.fx_amount && tx.fx_rate_to_base) {
          fx.fx_currency = String(tx.fx_currency).toUpperCase();
          fx.fx_amount = Number(tx.fx_amount);
          fx.fx_rate_to_base = Number(tx.fx_rate_to_base);
          fx.base_amount_from_fx = fx.fx_amount * fx.fx_rate_to_base;
          fx.recorded_base_amount = rawAmount;
          fx.fx_fee = Number(tx.fx_fee || 0);
          fx.fx_diff = fx.recorded_base_amount - fx.base_amount_from_fx - fx.fx_fee;
        } else {
          fx.fx_currency = txCurrency;
          fx.fx_amount = rawAmount;
          fx.fx_rate_to_base = txCurrency === baseCurrency ? 1 : 1;
          fx.base_amount_from_fx = rawAmount * fx.fx_rate_to_base;
          fx.recorded_base_amount = rawAmount;
          fx.fx_fee = Number(tx.fx_fee || 0);
          fx.fx_diff = 0;
        }

        const baseAmount = fx.recorded_base_amount;

        if (direction === "in") totalIn += baseAmount;
        else totalOut += baseAmount;

        // Classification
        const chain = (tx.chain || "OFFCHAIN").toUpperCase();
        const payment_channel = (tx.payment_channel || "unknown").toLowerCase();
        const desc = (tx.description || "").toLowerCase();

        let category = "other";
        let incomeCode = "4000";
        let incomeName = "Sales Revenue (Local)";

        if (chain === "BASE" || chain === "BSC" || chain === "ETH" || chain === "TON") {
          incomeCode = "4010";
          incomeName = "Sales Revenue (On-chain)";
        }
        if (chain === "PI") {
          incomeCode = "4011";
          incomeName = "Sales Revenue (Pi Network)";
        }

        if (direction === "in") {
          if (desc.includes("sale") || desc.includes("sales") || desc.includes("order") || desc.includes("payment received")) {
            category = chain === "PI" || chain === "BASE" || chain === "BSC" ? "onchain_income" : "income";
          } else {
            category = "income";
          }
        } else {
          if (desc.includes("rent")) category = "rent_expense";
          else if (desc.includes("inventory") || desc.includes("goods") || desc.includes("stock")) category = "goods_purchase";
          else if (desc.includes("exam") || desc.includes("tuition") || desc.includes("school") || desc.includes("university")) category = "education_expense";
          else if (desc.includes("subscription")) category = "subscription_expense";
          else if (desc.includes("fee") || desc.includes("gas")) category = "network_or_fee_expense";
          else if (desc.includes("graphic") || desc.includes("developer") || desc.includes("service") || desc.includes("professional")) category = "service_expense";
          else category = "operating_expense";
        }

        let matched_account_code = "9999";
        let matched_account_name = "Unclassified Transaction";

        if (direction === "in") {
          matched_account_code = incomeCode;
          matched_account_name = incomeName;
        } else {
          if (category === "goods_purchase") {
            matched_account_code = "5000";
            matched_account_name = "Cost of Goods Sold";
          } else if (category === "rent_expense") {
            matched_account_code = "6003";
            matched_account_name = "Rent Expense";
          } else if (category === "service_expense" || category === "education_expense" || category === "subscription_expense") {
            matched_account_code = "6002";
            matched_account_name = "Professional Fees Expense";
          } else if (category === "network_or_fee_expense") {
            matched_account_code = "6005";
            matched_account_name = "Network Fees (Gas)";
          } else {
            matched_account_code = "6001";
            matched_account_name = "Office & Shop Expenses";
          }
        }

        const classification = {
          category,
          matched_account_code,
          matched_account_name,
          confidence_score: 0.9
        };

        // Ledger entry (double entry)
        let debit, credit;
        if (direction === "in") {
          debit = { code: "1000", name: "Cash and Bank", amount: baseAmount };
          credit = { code: matched_account_code, name: matched_account_name, amount: baseAmount };
        } else {
          debit = { code: matched_account_code, name: matched_account_name, amount: baseAmount };
          credit = { code: "1000", name: "Cash and Bank", amount: baseAmount };
        }

        const ledger_entry = { debit, credit };

        // Tax analysis
        const taxCountry = tx.tax_country || tax_profile.country || business_profile.country || "Unknown";
        const tax_analysis = buildTaxAnalysis(baseAmount, direction, category, tax_profile);

        entries.push({
          transaction_id: tx.id || tx.tx_id || tx.hash || "TX-" + (entries.length + 1),
          date: tx.date || null,
          raw_description: tx.description || "",
          amount: baseAmount,
          original_amount: rawAmount,
          original_currency: txCurrency,
          direction,
          tax_country: taxCountry,
          chain: tx.chain || null,
          tx_hash: tx.tx_hash || null,
          wallet_address: tx.wallet_address || null,
          counterparty_wallet: tx.counterparty_wallet || null,
          payment_channel,
          counterparty_type: tx.counterparty_type || null,
          classification,
          ledger_entry,
          tax_analysis,
          fx
        });
      });

      const summary = {
        total_transactions: entries.length,
        total_inflows: Number(totalIn.toFixed(4)),
        total_outflows: Number(totalOut.toFixed(4)),
        notes: "Generated by AcePi Lite in the browser. For production, connect to the full AcePi engine."
      };

      return {
        business_profile,
        summary,
        entries
      };
    }

    function buildTaxAnalysis(amount, direction, category, tax_profile) {
      const vat_applicable = !!tax_profile.vat_applicable;
      const vat_rate = Number(tax_profile.vat_rate || 0);
      const treatInclusive = !!tax_profile.treat_sales_as_vat_inclusive;
      const withholdingEnabled = !!tax_profile.withholding_tax_enabled;

      let vat_amount = 0;
      let vat_type = "none";

      if (vat_applicable && vat_rate > 0) {
        if (direction === "in") {
          // Income side ‚Üí output VAT
          if (treatInclusive) {
            vat_amount = amount - amount / (1 + vat_rate);
          } else {
            vat_amount = amount * vat_rate;
          }
          vat_type = "output";
        } else {
          // Expense side ‚Üí input VAT
          if (treatInclusive) {
            vat_amount = amount - amount / (1 + vat_rate);
          } else {
            vat_amount = amount * vat_rate;
          }
          vat_type = "input";
        }
      }

      let withholding_tax_applicable = false;
      let withholding_tax_amount = 0;

      if (withholdingEnabled && direction === "out") {
        if (category === "rent_expense") {
          withholding_tax_applicable = true;
          withholding_tax_amount = amount * Number(tax_profile.default_wht_rent_rate || 0.10);
        } else if (category === "service_expense" || category === "education_expense" || category === "subscription_expense") {
          withholding_tax_applicable = true;
          withholding_tax_amount = amount * Number(tax_profile.default_wht_service_rate || 0.10);
        } else if (category === "goods_purchase") {
          withholding_tax_applicable = false;
        }
      }

      let tax_category = "other";
      if (direction === "in") tax_category = "taxable income";
      else tax_category = "allowable expense";

      return {
        vat_applicable,
        vat_amount: Number(vat_amount.toFixed(4)),
        vat_type,
        withholding_tax_applicable,
        withholding_tax_amount: Number(withholding_tax_amount.toFixed(4)),
        tax_category,
        tax_notes: "Lite estimate only ‚Äì final treatment depends on detailed tax rules and documentation."
      };
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Summary, analytics, FX overview & insights
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildSummary(result) {
      if (!result) return "(no summary yet)";
      const s = result.summary || {};
      const bp = result.business_profile || {};

      const lines = [];
      if (bp.business_name) lines.push(`Business: ${bp.business_name}`);
      if (bp.industry) lines.push(`Industry: ${bp.industry}`);
      if (bp.country) lines.push(`Country: ${bp.country}`);
      if (bp.base_currency) lines.push(`Base currency: ${bp.base_currency}`);
      lines.push("");
      lines.push(`Total transactions: ${s.total_transactions ?? 0}`);
      lines.push(`Total inflows: ${Number(s.total_inflows || 0).toFixed(2)}`);
      lines.push(`Total outflows: ${Number(s.total_outflows || 0).toFixed(2)}`);
      const net = (Number(s.total_inflows || 0) - Number(s.total_outflows || 0)).toFixed(2);
      lines.push(`Net: ${net}`);
      if (s.notes) {
        lines.push("");
        lines.push(s.notes);
      }
      return lines.join("\n");
    }

    function buildAnalytics(result) {
      if (!result || !Array.isArray(result.entries)) return "(no analytics yet)";
      const entries = result.entries;

      const byCategory = {};
      const byChain = {};
      const byChannel = {};

      entries.forEach(e => {
        const amt = Number(e.amount || 0);
        const cat = (e.classification && e.classification.category) || "unknown";
        const chain = (e.chain || "OFFCHAIN").toUpperCase();
        const channel = (e.payment_channel || "unknown").toLowerCase();

        if (!byCategory[cat]) byCategory[cat] = 0;
        byCategory[cat] += amt;

        if (!byChain[chain]) byChain[chain] = 0;
        byChain[chain] += amt;

        if (!byChannel[channel]) byChannel[channel] = 0;
        byChannel[channel] += amt;
      });

      const lines = [];
      lines.push("By category (sum of base amounts):");
      Object.keys(byCategory).sort().forEach(cat => {
        lines.push(`‚Ä¢ ${cat}: ${byCategory[cat].toFixed(2)}`);
      });

      lines.push("");
      lines.push("By chain (sum of base amounts):");
      Object.keys(byChain).sort().forEach(ch => {
        lines.push(`‚Ä¢ ${ch}: ${byChain[ch].toFixed(2)}`);
      });

      lines.push("");
      lines.push("By payment channel (sum of base amounts):");
      Object.keys(byChannel).sort().forEach(ch => {
        lines.push(`‚Ä¢ ${ch}: ${byChannel[ch].toFixed(2)}`);
      });

      return lines.join("\n");
    }

    function buildFxOverview(result) {
      if (!result || !Array.isArray(result.entries)) return "(no FX data yet)";
      const entries = result.entries;
      const perFx = {};

      entries.forEach(e => {
        const fx = e.fx || null;
        if (!fx || !fx.fx_currency) return;
        const cur = fx.fx_currency.toUpperCase();
        if (!perFx[cur]) {
          perFx[cur] = {
            count: 0,
            fx_amount: 0,
            base_from_fx: 0,
            recorded_base: 0,
            fx_fee: 0,
            fx_diff: 0
          };
        }
        const b = perFx[cur];
        b.count++;
        b.fx_amount += Number(fx.fx_amount || 0);
        b.base_from_fx += Number(fx.base_amount_from_fx || 0);
        b.recorded_base += Number(fx.recorded_base_amount || 0);
        b.fx_fee += Number(fx.fx_fee || 0);
        b.fx_diff += Number(fx.fx_diff || 0);
      });

      const keys = Object.keys(perFx);
      if (!keys.length) return "(no FX data yet)";

      const lines = [];
      keys.sort().forEach(cur => {
        const b = perFx[cur];
        lines.push(
          `${cur}: tx=${b.count}, fx_amount=${b.fx_amount.toFixed(2)}, base_from_fx=${b.base_from_fx.toFixed(2)}, recorded_base=${b.recorded_base.toFixed(2)}, fx_fee=${b.fx_fee.toFixed(2)}, fx_diff=${b.fx_diff.toFixed(2)}`
        );
      });
      return lines.join("\n");
    }

    function buildInsights(result) {
      if (!result || !Array.isArray(result.entries)) return "(no insights yet)";
      const entries = result.entries;
      if (!entries.length) return "(no insights yet)";

      const summary = result.summary || {};
      const totalTx = summary.total_transactions ?? entries.length;
      const totalIn = Number(summary.total_inflows || 0);
      const totalOut = Number(summary.total_outflows || 0);
      const net = totalIn - totalOut;

      const perCountry = {};
      const perFx = {};
      const perChain = {};
      const perChannel = {};

      entries.forEach(e => {
        const amt = Number(e.amount || 0);
        const dir = e.direction || null;
        const inflowAmt = dir === "in" ? amt : 0;
        const outflowAmt = dir === "out" ? amt : 0;

        const country = e.tax_country || "Unknown";
        if (!perCountry[country]) {
          perCountry[country] = { count: 0, inflows: 0, outflows: 0, vat: 0, wht: 0 };
        }
        const c = perCountry[country];
        c.count++;
        c.inflows += inflowAmt;
        c.outflows += outflowAmt;
        if (e.tax_analysis) {
          c.vat += Number(e.tax_analysis.vat_amount || 0);
          c.wht += Number(e.tax_analysis.withholding_tax_amount || 0);
        }

        const fx = e.fx || null;
        if (fx && fx.fx_currency) {
          const cur = fx.fx_currency.toUpperCase();
          if (!perFx[cur]) {
            perFx[cur] = { count: 0, fx_amount: 0, recorded_base: 0 };
          }
          const f = perFx[cur];
          f.count++;
          if (fx.fx_amount != null) f.fx_amount += Number(fx.fx_amount) || 0;
          if (fx.recorded_base_amount != null) f.recorded_base += Number(fx.recorded_base_amount) || 0;
        }

        const chain = (e.chain || "OFFCHAIN").toUpperCase();
        if (!perChain[chain]) perChain[chain] = { count: 0, volume: 0 };
        perChain[chain].count++;
        perChain[chain].volume += amt;

        const channel = (e.payment_channel || "unknown").toLowerCase();
        if (!perChannel[channel]) perChannel[channel] = { count: 0, volume: 0 };
        perChannel[channel].count++;
        perChannel[channel].volume += amt;
      });

      function topBy(obj, field) {
        const keys = Object.keys(obj);
        if (!keys.length) return null;
        return keys
          .map(k => ({ key: k, ...obj[k] }))
          .sort((a, b) => (b[field] || 0) - (a[field] || 0))[0];
      }

      const topCountry = topBy(perCountry, "inflows");
      const topFx = topBy(perFx, "recorded_base");
      const topChain = topBy(perChain, "volume");
      const topChannel = topBy(perChannel, "volume");

      const lines = [];

      lines.push("Ace Insights ‚Äì Draft Narrative");
      lines.push("================================");
      lines.push("");
      lines.push("1) Executive Snapshot");
      lines.push(
        `‚Ä¢ Transactions processed: ${totalTx} | Total inflows: ${totalIn.toFixed(2)} | Total outflows: ${totalOut.toFixed(2)} | Net: ${net.toFixed(2)}`
      );
      if (topCountry) {
        lines.push(
          `‚Ä¢ Most active tax country: ${topCountry.key} (inflows: ${topCountry.inflows.toFixed(2)}, outflows: ${topCountry.outflows.toFixed(2)})`
        );
      }
      if (topFx) {
        lines.push(
          `‚Ä¢ Main FX currency: ${topFx.key} (fx amount: ${topFx.fx_amount.toFixed(2)}, base volume: ${topFx.recorded_base.toFixed(2)})`
        );
      }
      if (topChain) {
        lines.push(
          `‚Ä¢ Dominant chain: ${topChain.key} (volume: ${topChain.volume.toFixed(2)})`
        );
      }
      if (topChannel) {
        lines.push(
          `‚Ä¢ Key payment channel: ${topChannel.key} (volume: ${topChannel.volume.toFixed(2)})`
        );
      }

      lines.push("");
      lines.push("2) Tax & Compliance Signals");
      const countryKeys = Object.keys(perCountry).sort();
      if (!countryKeys.length) {
        lines.push("‚Ä¢ No tax country breakdown available.");
      } else {
        countryKeys.forEach(ct => {
          const c = perCountry[ct];
          lines.push(
            `‚Ä¢ ${ct}: VAT = ${c.vat.toFixed(2)}, WHT = ${c.wht.toFixed(2)}, tx = ${c.count}, net = ${(c.inflows - c.outflows).toFixed(2)}`
          );
        });
      }

      lines.push("");
      lines.push("3) FX Exposure View");
      const fxKeys = Object.keys(perFx);
      if (!fxKeys.length) {
        lines.push("‚Ä¢ No FX-tagged transactions in this dataset.");
      } else {
        fxKeys.sort().forEach(cur => {
          const f = perFx[cur];
          lines.push(
            `‚Ä¢ ${cur}: fx_amount=${f.fx_amount.toFixed(2)}, recorded_base=${f.recorded_base.toFixed(2)}`
          );
        });
      }

      lines.push("");
      lines.push("4) Channels & Chains Focus");
      const chainKeys = Object.keys(perChain).sort();
      if (chainKeys.length) {
        lines.push("‚Ä¢ Chains:");
        chainKeys.forEach(ch => {
          const b = perChain[ch];
          lines.push(`   - ${ch}: tx=${b.count}, volume=${b.volume.toFixed(2)}`);
        });
      }
      const chanKeys = Object.keys(perChannel).sort();
      if (chanKeys.length) {
        lines.push("‚Ä¢ Payment channels:");
        chanKeys.forEach(ch => {
          const b = perChannel[ch];
          lines.push(`   - ${ch}: tx=${b.count}, volume=${b.volume.toFixed(2)}`);
        });
      }

      lines.push("");
      lines.push("5) X / Twitter Draft (You can refine)");
      lines.push("");
      lines.push("Hook: Today‚Äôs ledger tells a deeper story than just numbers.");
      lines.push(
        `Body: We processed ${totalTx} transactions across ${countryKeys.length || 1} tax jurisdictions, with net cash flow of ${net.toFixed(2)} in base currency.` +
          (topChain ? ` On-chain activity on ${topChain.key} is emerging as a key rail,` : "") +
          (topFx ? ` while ${topFx.key} remains the primary FX exposure.` : "")
      );
      lines.push(
        "CTA: If you‚Äôre not reading your on-chain and FX flows like a story, you‚Äôre leaving strategy on the table."
      );
      lines.push("");
      lines.push("‚Üí Copy, personalise, add scripture/insight, then post.");

      return lines.join("\n");
    }
  </script>
</body>
</html>
